name: dockerpushaws
on: [pull_request,push,issues,workflow_dispatch]
env:
  AZURE_WEBAPP_NAME: "GitActionAPI"
  AZURE_CONTAINER_NAME: "gitcollabapi"
  IMAGE_NAME: gitcollabapi
jobs:
  Build:
    runs-on: windows-latest
    steps:
      - name: catch Event Name
        run: echo "Event that triggered the work flow is ${{ github.event_name }}"
      - name: CheckingOut Repository
        uses: actions/checkout@v3
        
      - name: build-app
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x
          
      - name: Install dependencies
        run: dotnet restore ./GitCollab/GitCollab.csproj
        
      - name: Build
        run: dotnet build ./GitCollab/GitCollab.csproj --configuration Release --no-restore

  Test:
    needs: Build
    runs-on: windows-latest
    steps:
      - name: CheckingOut Repository
        uses: actions/checkout@v3
        
      - name: Install TestCase dependencies
        run: dotnet restore ./TestingGitAPI/TestingGitAPI.csproj
        
      - name: Run Unit Tests
        run: dotnet test --configuration Release --no-restore --verbosity normal
        
      - name: Notify on Test Failure
        if: failure()
        run: echo "Tests failed! Fix errors before deployment."
        
  build-and-push:
    needs: Test
    runs-on: ubuntu-latest
   
    steps:
      - name: CheckingOut Repository
        uses: actions/checkout@v3

      - name: Log in to AWS ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build Docker Image
        run: |
          echo "${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:latest"
          docker build -t ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:latest .

      - name: Push Docker Image to AWS ECR
        run: |
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:latest
